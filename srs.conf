# SRS Configuration for Live Streaming - Optimized for Production
# Based on SRS v6.0 (Stable) best practices for stability and performance

# Global Settings - Optimized for Stability
listen              1935;
max_connections     1000;
daemon              off;
srs_log_tank        file;
srs_log_file        ./objs/srs.log;
srs_log_level       warn;              # Reduced to warn for maximum stability and performance
srs_log_file_size   10000000;          # 10MB log file size limit

# HTTP Server for HLS delivery
http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
    crossdomain     on;
}

# HTTP API for monitoring and control
http_api {
    enabled         on;
    listen          1985;
    crossdomain     on;
}

# Stats Server for monitoring
stats {
    network         0;
}

# Default Virtual Host Configuration
vhost __defaultVhost__ {
    # TCP Settings - Optimized for Stability (not ultra-low latency)
    tcp_nodelay     on;
    min_latency     off;                
    
    mr              on;
    mw_latency      350;                
    
    # RTMP Settings - Optimized for stability
    chunk_size      60000;
    
    # HLS Configuration - Optimized for STABILITY with 200+ concurrent users
    # Priority: Stability > Low Latency
    hls {
        enabled             on;
        hls_path            ./objs/nginx/html;
        hls_fragment        4;          # 4 seconds - reduces I/O by 75% vs 1s, much more stable
        hls_window          20;         #  - excellent buffering for stability
        hls_cleanup         on;
        hls_dispose         3;          # Keep 5 segments after stream ends (more conservative)
        hls_wait_keyframe   on;         # Wait for keyframe - ensures quality and stability
        hls_nb_notify       2;         
        hls_acodec          aac;        # Audio codec
        hls_vcodec          h264;       # Video codec
        hls_m3u8_file       [app]/[stream]/index.m3u8;
        hls_ts_file         [app]/[stream]/[stream]-[seq].ts;
        hls_keys            off;        # Disable encryption for simplicity (enable if needed)
        hls_fragment_per_keyframe off;   # Don't force keyframe per fragment
    }
    
   
    
    # HTTP Callbacks - Optimized
    http_hooks {
        enabled         on;
        on_publish      http://backend:8080/api/stream/callback/publish;
        on_unpublish    http://backend:8080/api/stream/callback/unpublish;
        on_play         http://backend:8080/api/stream/callback/play;
        on_stop         http://backend:8080/api/stream/callback/stop;
        timeout         4000;           # 5 seconds timeout (increased from 3s)
        retry           2;              # Retry 3 times on failure
    }
    
   
}
